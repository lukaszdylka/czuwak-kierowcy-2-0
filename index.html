<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Czuwak Kierowcy 2.0</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkN6dXdhayBLaWVyb3djeSAyLjAiLAogICJzaG9ydF9uYW1lIjogIkN6dXdhayIsCiAgImRlc2NyaXB0aW9uIjogIkFwbGlrYWNqYSBkbGEga2llcm93Y8OzdyBqZcW8ZHrEhWN5Y2ggbm9jxIUiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAiZnVsbHNjcmVlbiIsCiAgInRoZW1lX2NvbG9yIjogIiMxYTFhMWEiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMxYTFhMWEiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSmhkWFJ2SWlCb1pXbG5hSFE5SW1GMWRHOGlJSFpwWlhkQ2IzZzlJakFnTUNBek1pQXpNaUlnWm1sc2JEMGlJelJpTkdSbVppSTZQSEpsWTNRZ2VEMGlOaUlnZVQwaU5pSWdkMmxrZEdnOUlqSXdJaUJvWldsbmFIUTlJakl3SWlCbWFXeHNQU0lqWXpReVl6UWlMejQ4TDNOMlp6ND0iLAogICAgICAic2l6ZXMiOiAiMzJ4MzIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    <meta name="theme-color" content="#1a1a1a">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
            user-select: none;
            -webkit-user-select: none;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #4CAF50;
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .speed-display {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .status-text {
            font-size: 14px;
            color: #cccccc;
        }

        .interval-selector {
            margin-bottom: 20px;
        }

        .interval-selector label {
            display: block;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .interval-selector select {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            appearance: none;
        }

        .auto-start-section {
            background: rgba(76, 175, 80, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .alerts-section {
            background: rgba(244, 67, 54, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ff9800;
            display: flex;
            align-items: center;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-container label {
            font-size: 14px;
            cursor: pointer;
            margin: 0;
        }

        .speed-threshold {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .speed-threshold input[type="number"] {
            width: 80px;
            padding: 8px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            text-align: center;
            margin: 0 10px;
        }

        .speed-threshold span {
            font-size: 14px;
            color: #cccccc;
        }

        .control-buttons {
            margin-bottom: 30px;
        }

        .btn {
            width: 100%;
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-start {
            background: #4CAF50;
            color: white;
        }

        .btn-stop {
            background: #f44336;
            color: white;
        }

        .btn-pause {
            background: #ff9800;
            color: white;
        }

        .alert-button {
            background: #ff1744;
            color: white;
            font-size: 28px;
            font-weight: bold;
            padding: 40px;
            border-radius: 20px;
            animation: pulse 2s infinite;
            margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(255, 23, 68, 0.5);
            border: 3px solid #ff5574;
        }

        @keyframes pulse {
            0% { 
                transform: scale(1); 
                box-shadow: 0 0 30px rgba(255, 23, 68, 0.5);
            }
            50% { 
                transform: scale(1.05); 
                box-shadow: 0 0 50px rgba(255, 23, 68, 0.8);
            }
            100% { 
                transform: scale(1); 
                box-shadow: 0 0 30px rgba(255, 23, 68, 0.5);
            }
        }

        .countdown {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            color: #ff1744;
            margin-bottom: 20px;
        }

        .alarm-flash {
            animation: flash 0.3s infinite;
        }

        @keyframes flash {
            0%, 40% { 
                background: linear-gradient(135deg, #ff1744, #ff5574);
                color: #ffffff;
            }
            41%, 100% { 
                background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
                color: #ffffff;
            }
        }

        .flashlight-active {
            animation: flashlight 0.5s infinite;
        }

        @keyframes flashlight {
            0%, 50% { filter: brightness(200%); }
            51%, 100% { filter: brightness(100%); }
        }

        .hidden {
            display: none;
        }

        .next-alert {
            text-align: center;
            font-size: 14px;
            color: #888;
            margin-top: 20px;
        }

        .gps-status {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin-top: 10px;
        }

        .vehicle-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-top: 10px;
        }

        .vehicle-moving {
            background: #4CAF50;
            color: white;
        }

        .gps-request {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid #2196F3;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .gps-request.hidden {
            display: none;
        }

        .btn-gps {
            background: #2196F3;
            color: white;
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        .vehicle-stopped {
            background: #ff9800;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Czuwak Kierowcy 2.0</h1>
        </div>

        <div class="status-bar">
            <div class="speed-display">
                <span id="speed">-- km/h</span>
                <div class="vehicle-status hidden" id="vehicleStatus">
                    <span id="vehicleStatusText">Sprawdzanie GPS...</span>
                </div>
            </div>
            <div class="status-text" id="statusText">Nieaktywny</div>
            <div class="gps-status" id="gpsStatus">GPS: Sprawdzanie...</div>
        </div>

        <div class="gps-request" id="gpsRequest">
            <h3>üìç Wymagane uprawnienia GPS</h3>
            <p>Czuwak potrzebuje dostƒôpu do lokalizacji aby:</p>
            <ul style="text-align: left; margin: 10px 0;">
                <li>üìä Wy≈õwietlaƒá aktualnƒÖ prƒôdko≈õƒá</li>
                <li>‚è∏Ô∏è Pauzowaƒá gdy stoisz</li>
                <li>üèéÔ∏è Auto-start przy spadku prƒôdko≈õci</li>
            </ul>
            <button class="btn-gps" id="requestGpsBtn">üó∫Ô∏è W≈ÇƒÖcz GPS</button>
            <p style="font-size: 12px; margin-top: 10px; color: #888;">
                Aplikacja dzia≈Ça bez GPS, ale funkcje bƒôdƒÖ ograniczone
            </p>
        </div>

        <div class="interval-selector">
            <label for="interval">Interwa≈Ç przypomnie≈Ñ:</label>
            <select id="interval">
                <option value="30">30 sekund</option>
                <option value="60" selected>1 minuta</option>
                <option value="120">2 minuty</option>
                <option value="300">5 minut</option>
                <option value="600">10 minut</option>
            </select>
        </div>

        <div class="auto-start-section">
            <div class="checkbox-container">
                <input type="checkbox" id="autoStartEnabled">
                <label for="autoStartEnabled">üèéÔ∏è Auto-start przy spadku prƒôdko≈õci</label>
            </div>
            <div class="speed-threshold">
                <span>Uruchom gdy prƒôdko≈õƒá spadnie poni≈ºej:</span>
                <input type="number" id="speedThreshold" value="120" min="50" max="200" step="10">
                <span>km/h</span>
            </div>
        </div>

        <div class="alerts-section">
            <div class="section-title">üö® Opcje alert√≥w</div>
            
            <div class="checkbox-container">
                <input type="checkbox" id="vibrationsEnabled">
                <label for="vibrationsEnabled">üì≥ Wibracje telefonu</label>
            </div>

            <div class="checkbox-container">
                <input type="checkbox" id="flashlightEnabled">
                <label for="flashlightEnabled">üí° MigajƒÖca latarka/ekran</label>
            </div>

            <div class="checkbox-container">
                <input type="checkbox" id="alwaysAudio" checked>
                <label for="alwaysAudio">üîä D≈∫wiƒôk zawsze aktywny</label>
            </div>
        </div>

        <div class="control-buttons">
            <button class="btn btn-start" id="startBtn">üü¢ Rozpocznij</button>
            <button class="btn btn-pause hidden" id="pauseBtn">‚è∏Ô∏è Zatrzymaj</button>
            <button class="btn btn-stop hidden" id="stopBtn">üõë Zako≈Ñcz</button>
        </div>

        <div class="alert-section hidden" id="alertSection">
            <div class="countdown" id="countdown">15</div>
            <button class="btn alert-button" id="alertBtn">
                üö® CZUWAM! üö®
            </button>
        </div>

        <div class="next-alert" id="nextAlert"></div>

        <audio id="alarmSound" loop preload="auto">
            <source src="alarm.mp3" type="audio/mpeg">
            <source src="alarm.wav" type="audio/wav">
            <source src="alarm.ogg" type="audio/ogg">
        </audio>
    </div>

    <script>
        class CzuwakKierowcy {
            constructor() {
                this.isActive = false;
                this.isPaused = false;
                this.interval = 60;
                this.alertTimer = null;
                this.countdownTimer = null;
                this.nextAlertTimer = null;
                this.wakeLock = null;
                this.geolocationWatcher = null;
                this.currentSpeed = 0;
                this.isVehicleMoving = false;
                this.lastPosition = null;
                this.autoStartEnabled = false;
                this.speedThreshold = 120;
                this.wasAboveThreshold = false;
                
                // Opcje alert√≥w
                this.vibrationsEnabled = false;
                this.flashlightEnabled = false;
                this.alwaysAudio = true;
                this.flashlightStream = null;
                
                this.initElements();
                this.initEventListeners();
                this.requestWakeLock();
                this.createAlarmSound();
                
                // Inicjalizuj GPS z op√≥≈∫nieniem
                setTimeout(() => {
                    this.initGeolocation();
                }, 500);
            }

            initElements() {
                this.intervalSelect = document.getElementById('interval');
                this.startBtn = document.getElementById('startBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.alertSection = document.getElementById('alertSection');
                this.alertBtn = document.getElementById('alertBtn');
                this.countdown = document.getElementById('countdown');
                this.statusText = document.getElementById('statusText');
                this.speedDisplay = document.getElementById('speed');
                this.gpsStatus = document.getElementById('gpsStatus');
                this.vehicleStatus = document.getElementById('vehicleStatus');
                this.vehicleStatusText = document.getElementById('vehicleStatusText');
                this.nextAlert = document.getElementById('nextAlert');
                this.alarmSound = document.getElementById('alarmSound');
                this.autoStartCheckbox = document.getElementById('autoStartEnabled');
                this.speedThresholdInput = document.getElementById('speedThreshold');
                
                // Opcje alert√≥w
                this.vibrationsCheckbox = document.getElementById('vibrationsEnabled');
                this.flashlightCheckbox = document.getElementById('flashlightEnabled');
                this.alwaysAudioCheckbox = document.getElementById('alwaysAudio');
                
                // GPS request
                this.gpsRequest = document.getElementById('gpsRequest');
                this.requestGpsBtn = document.getElementById('requestGpsBtn');
            }

            createAlarmSound() {
                // Pr√≥bujemy u≈ºyƒá zewnƒôtrznego pliku audio
                this.alarmSound.addEventListener('loadeddata', () => {
                    console.log('Zewnƒôtrzny plik alarm.mp3 za≈Çadowany pomy≈õlnie');
                    this.useExternalAudio = true;
                });

                this.alarmSound.addEventListener('error', () => {
                    console.log('Nie mo≈ºna za≈Çadowaƒá alarm.mp3, u≈ºywam syntetycznego d≈∫wiƒôku');
                    this.useExternalAudio = false;
                    this.createSyntheticAlarm();
                });

                // Sprawd≈∫ czy plik jest dostƒôpny
                this.alarmSound.load();
                this.useExternalAudio = false; // Domy≈õlnie false, zostanie zmienione je≈õli plik siƒô za≈Çaduje
                
                // Przygotuj zapasowy syntetyczny d≈∫wiƒôk
                this.createSyntheticAlarm();
            }

            createSyntheticAlarm() {
                // Tworzymy syntetyczny d≈∫wiƒôk alarmu za pomocƒÖ Web Audio API
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    this.createAlarmBuffer = () => {
                        const sampleRate = audioContext.sampleRate;
                        const duration = 1.0;
                        const buffer = audioContext.createBuffer(1, sampleRate * duration, sampleRate);
                        const data = buffer.getChannelData(0);
                        
                        for (let i = 0; i < data.length; i++) {
                            const time = i / sampleRate;
                            const frequency = 800 + 400 * Math.sin(2 * Math.PI * 2 * time);
                            data[i] = 0.3 * Math.sin(2 * Math.PI * frequency * time);
                        }
                        
                        return buffer;
                    };

                    this.alarmBuffer = this.createAlarmBuffer();
                    this.alarmSource = null;
                } catch (error) {
                    console.log('Web Audio API nie jest dostƒôpne');
                }
            }

            playAlarm() {
                // Wibracje
                this.triggerVibration();

                // Latarka/migajƒÖcy ekran
                if (this.flashlightEnabled) {
                    this.initFlashlight();
                }

                // Audio - tylko je≈õli w≈ÇƒÖczone
                if (this.alwaysAudio) {
                    // Najpierw spr√≥buj odtworzyƒá zewnƒôtrzny plik audio
                    if (this.useExternalAudio && this.alarmSound) {
                        try {
                            this.alarmSound.currentTime = 0;
                            this.alarmSound.volume = 1.0;
                            const playPromise = this.alarmSound.play();
                            
                            if (playPromise !== undefined) {
                                playPromise.then(() => {
                                    console.log('Odtwarzanie zewnƒôtrznego pliku alarm.mp3');
                                }).catch(error => {
                                    console.log('B≈ÇƒÖd odtwarzania zewnƒôtrznego pliku, prze≈ÇƒÖczam na syntetyczny');
                                    this.playSyntheticAlarm();
                                });
                            }
                        } catch (error) {
                            console.log('B≈ÇƒÖd odtwarzania zewnƒôtrznego pliku, prze≈ÇƒÖczam na syntetyczny');
                            this.playSyntheticAlarm();
                        }
                    } else {
                        // U≈ºyj syntetycznego d≈∫wiƒôku jako backup
                        this.playSyntheticAlarm();
                    }
                }
                
                document.body.classList.add('alarm-flash');
            }

            playSyntheticAlarm() {
                try {
                    if (this.alarmSource) {
                        this.alarmSource.stop();
                    }
                    
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.alarmSource = audioContext.createBufferSource();
                    this.alarmSource.buffer = this.alarmBuffer;
                    this.alarmSource.loop = true;
                    this.alarmSource.connect(audioContext.destination);
                    this.alarmSource.start();
                    console.log('Odtwarzanie syntetycznego alarmu');
                } catch (error) {
                    console.log('Nie mo≈ºna odtworzyƒá ≈ºadnego d≈∫wiƒôku');
                }
            }

            triggerVibration() {
                if (this.vibrationsEnabled && 'vibrate' in navigator) {
                    // Wz√≥r wibracji: [vibrate, pause, vibrate, pause, ...]
                    navigator.vibrate([500, 200, 500, 200, 1000]);
                }
    
