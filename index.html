<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Czuwak Kierowcy 2.0</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkN6dXdhayBLaWVyb3djeSAyLjAiLAogICJzaG9ydF9uYW1lIjogIkN6dXdhayIsCiAgImRlc2NyaXB0aW9uIjogIkFwbGlrYWNqYSBkbGEga2llcm93Y8OzdyBqZcW8ZHrEhWN5Y2ggbm9jxIUiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAiZnVsbHNjcmVlbiIsCiAgInRoZW1lX2NvbG9yIjogIiMxYTFhMWEiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMxYTFhMWEiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSmhkWFJ2SWlCb1pXbG5hSFE5SW1GMWRHOGlJSFpwWlhkQ2IzZzlJakFnTUNBek1pQXpNaUlnWm1sc2JEMGlJelJpTkdSbVppSTZQSEpsWTNRZ2VEMGlOaUlnZVQwaU5pSWdkMmxrZEdnOUlqSXdJaUJvWldsbmFIUTlJakl3SWlCbWFXeHNQU0lqWXpReVl6UWlMejQ4TDNOMlp6ND0iLAogICAgICAic2l6ZXMiOiAiMzJ4MzIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    <meta name="theme-color" content="#1a1a1a">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
            user-select: none;
            -webkit-user-select: none;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #4CAF50;
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .speed-display {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .status-text {
            font-size: 14px;
            color: #cccccc;
        }

        .interval-selector {
            margin-bottom: 20px;
        }

        .interval-selector label {
            display: block;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .interval-selector select {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            appearance: none;
        }

        .auto-start-section {
            background: rgba(76, 175, 80, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .settings-section {
            background: rgba(255, 152, 0, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        .copilot-section {
            background: rgba(156, 39, 176, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(156, 39, 176, 0.3);
        }

        .alerts-section {
            background: rgba(244, 67, 54, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .settings-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ff9800;
            display: flex;
            align-items: center;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
        }

        .setting-label {
            font-size: 14px;
            color: #cccccc;
        }

        .setting-control select {
            padding: 5px 10px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-size: 14px;
        }

        .fatigue-indicator {
            display: none;
            background: rgba(255, 87, 34, 0.2);
            border: 1px solid #ff5722;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            animation: pulse-warning 2s infinite;
        }

        .fatigue-indicator.show {
            display: block;
        }

        @keyframes pulse-warning {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.8; }
        }

        .stats-display {
            background: rgba(33, 150, 243, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
            color: #81C784;
        }

        .qr-code {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 15px 0;
            display: none;
        }

        .qr-code.show {
            display: block;
        }

        .qr-code canvas {
            border: 2px solid #ddd;
            border-radius: 8px;
        }

        .connection-status {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
            font-size: 14px;
        }

        .status-disconnected {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
        }

        .status-connected {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            color: #4CAF50;
        }

        .voice-indicator {
            display: none;
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196F3;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            animation: pulse 1s infinite;
        }

        .voice-indicator.listening {
            display: block;
        }

        .copilot-interface {
            display: none;
            text-align: center;
        }

        .copilot-interface.active {
            display: block;
        }

        .copilot-alert {
            background: #ff1744;
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 20px;
            font-weight: bold;
            animation: emergency-pulse 1s infinite;
        }

        @keyframes emergency-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        .flashlight-active {
            animation: flashlight 0.5s infinite;
        }

        @keyframes flashlight {
            0%, 50% { filter: brightness(200%); }
            51%, 100% { filter: brightness(100%); }
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-container label {
            font-size: 14px;
            cursor: pointer;
            margin: 0;
        }

        .speed-threshold {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .speed-threshold input[type="number"] {
            width: 80px;
            padding: 8px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            text-align: center;
            margin: 0 10px;
        }

        .speed-threshold span {
            font-size: 14px;
            color: #cccccc;
        }

        .control-buttons {
            margin-bottom: 30px;
        }

        .btn {
            width: 100%;
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-start {
            background: #4CAF50;
            color: white;
        }

        .btn-stop {
            background: #f44336;
            color: white;
        }

        .btn-pause {
            background: #ff9800;
            color: white;
        }

        .alert-button {
            background: #ff1744;
            color: white;
            font-size: 28px;
            font-weight: bold;
            padding: 40px;
            border-radius: 20px;
            animation: pulse 2s infinite;
            margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(255, 23, 68, 0.5);
            border: 3px solid #ff5574;
        }

        @keyframes pulse {
            0% { 
                transform: scale(1); 
                box-shadow: 0 0 30px rgba(255, 23, 68, 0.5);
            }
            50% { 
                transform: scale(1.05); 
                box-shadow: 0 0 50px rgba(255, 23, 68, 0.8);
            }
            100% { 
                transform: scale(1); 
                box-shadow: 0 0 30px rgba(255, 23, 68, 0.5);
            }
        }

        .countdown {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            color: #ff1744;
            margin-bottom: 20px;
        }

        .alarm-flash {
            animation: flash 0.3s infinite;
        }

        @keyframes flash {
            0%, 40% { 
                background: linear-gradient(135deg, #ff1744, #ff5574);
                color: #ffffff;
            }
            41%, 100% { 
                background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
                color: #ffffff;
            }
        }

        .hidden {
            display: none;
        }

        .next-alert {
            text-align: center;
            font-size: 14px;
            color: #888;
            margin-top: 20px;
        }

        .gps-status {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin-top: 10px;
        }

        .vehicle-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-top: 10px;
        }

        .vehicle-moving {
            background: #4CAF50;
            color: white;
        }

        .vehicle-stopped {
            background: #ff9800;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚗 Czuwak Kierowcy 2.0</h1>
        </div>

        <div class="alerts-section">
            <div class="settings-title">🚨 Opcje alertów</div>
            
            <div class="checkbox-container">
                <input type="checkbox" id="voiceCommands">
                <label for="voiceCommands">🗣️ Komendy głosowe ("Czuwam")</label>
            </div>

            <div class="checkbox-container">
                <input type="checkbox" id="vibrationsEnabled">
                <label for="vibrationsEnabled">📳 Wibracje telefonu</label>
            </div>

            <div class="checkbox-container">
                <input type="checkbox" id="flashlightEnabled">
                <label for="flashlightEnabled">💡 Migająca latarka</label>
            </div>

            <div class="checkbox-container">
                <input type="checkbox" id="alwaysAudio" checked>
                <label for="alwaysAudio">🔊 Dźwięk zawsze aktywny</label>
            </div>
        </div>

        <div class="copilot-section">
            <div class="settings-title">👥 Tryb współkierowcy</div>
            
            <div class="checkbox-container">
                <input type="checkbox" id="copilotMode">
                <label for="copilotMode">Włącz tryb współkierowcy</label>
            </div>

            <div class="qr-code" id="qrCode">
                <h3>Zeskanuj kod w drugiej aplikacji:</h3>
                <canvas id="qrCanvas"></canvas>
                <p>Session ID: <span id="sessionId"></span></p>
            </div>

            <div class="connection-status status-disconnected" id="connectionStatus">
                🔴 Współkierowca niepołączony
            </div>
        </div>

        <div class="voice-indicator" id="voiceIndicator">
            🎤 Słucham... Powiedz "Czuwam"
        </div>

        <div class="status-bar">
            <div class="speed-display">
                <span id="speed">-- km/h</span>
                <div class="vehicle-status hidden" id="vehicleStatus">
                    <span id="vehicleStatusText">Sprawdzanie GPS...</span>
                </div>
            </div>
            <div class="status-text" id="statusText">Nieaktywny</div>
            <div class="gps-status" id="gpsStatus">GPS: Sprawdzanie...</div>
        </div>

        <div class="interval-selector">
            <label for="interval">Interwał przypomnień:</label>
            <select id="interval">
                <option value="30">30 sekund</option>
                <option value="60" selected>1 minuta</option>
                <option value="120">2 minuty</option>
                <option value="300">5 minut</option>
                <option value="600">10 minut</option>
            </select>
        </div>

        <div class="auto-start-section">
            <div class="checkbox-container">
                <input type="checkbox" id="autoStartEnabled">
                <label for="autoStartEnabled">🏎️ Auto-start przy spadku prędkości</label>
            </div>
            <div class="speed-threshold">
                <span>Uruchom gdy prędkość spadnie poniżej:</span>
                <input type="number" id="speedThreshold" value="120" min="50" max="200" step="10">
                <span>km/h</span>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-title">⚙️ Ustawienia bezpieczeństwa</div>
            
            <div class="setting-row">
                <span class="setting-label">🚗 Tryb jazdy:</span>
                <div class="setting-control">
                    <select id="drivingMode">
                        <option value="city">🏙️ Miasto (częste alerty)</option>
                        <option value="highway" selected>🛣️ Autostrada (standardowe)</option>
                        <option value="night">🌙 Noc (intensywne)</option>
                        <option value="fatigue">😴 Zmęczenie (bardzo częste)</option>
                    </select>
                </div>
            </div>

            <div class="setting-row">
                <span class="setting-label">🧠 Detekcja zmęczenia:</span>
                <div class="setting-control">
                    <select id="fatigueDetection">
                        <option value="off">Wyłączona</option>
                        <option value="basic" selected>Podstawowa</option>
                        <option value="advanced">Zaawansowana</option>
                    </select>
                </div>
            </div>

            <div class="setting-row">
                <span class="setting-label">⏰ Smart scheduling:</span>
                <div class="setting-control">
                    <select id="smartScheduling">
                        <option value="off">Wyłączony</option>
                        <option value="time" selected>Godziny ryzyka</option>
                        <option value="adaptive">Adaptacyjny</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="fatigue-indicator" id="fatigueWarning">
            <strong>⚠️ WYKRYTO OZNAKI ZMĘCZENIA!</strong><br>
            <span id="fatigueMessage">Rozważ przerwę w jeździe</span>
        </div>

        <div class="stats-display" id="sessionStats" style="display: none;">
            📊 <strong>Sesja:</strong> <span id="sessionTime">0:00</span> | 
            Reakcje: <span id="reactionCount">0</span> | 
            Średni czas: <span id="avgReaction">-</span>
        </div>

        <div class="control-buttons">
            <button class="btn btn-start" id="startBtn">🟢 Rozpocznij</button>
            <button class="btn btn-pause hidden" id="pauseBtn">⏸️ Zatrzymaj</button>
            <button class="btn btn-stop hidden" id="stopBtn">🛑 Zakończ</button>
        </div>

        <!-- Interfejs współkierowcy -->
        <div class="copilot-interface" id="copilotInterface">
            <h2>👥 Tryb Współkierowcy</h2>
            <p>Monitorujesz kierowcę. Zostaniesz powiadomiony o alertach.</p>
            
            <div class="connection-status status-disconnected" id="copilotConnectionStatus">
                🔴 Oczekiwanie na połączenie...
            </div>

            <div class="copilot-alert" id="copilotAlert" style="display: none;">
                🚨 KIEROWCA NIE REAGUJE! 🚨<br>
                <button class="btn" onclick="copilotApp.wakeDriver()">📢 Zbudź kierowcę</button>
            </div>

            <button class="btn btn-stop" onclick="copilotApp.disconnect()">❌ Rozłącz</button>
        </div>

        <div class="alert-section hidden" id="alertSection">
            <div class="countdown" id="countdown">15</div>
            <button class="btn alert-button" id="alertBtn">
                🚨 CZUWAM! 🚨
            </button>
        </div>

        <div class="next-alert" id="nextAlert"></div>

        <audio id="alarmSound" loop>
            <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYfAjGJ0PLMNC8FMIn" preload="auto"></audio>
    </div>

    <script>
        class CzuwakKierowcy {
            constructor() {
                this.isActive = false;
                this.isPaused = false;
                this.interval = 60;
                this.alertTimer = null;
                this.countdownTimer = null;
                this.nextAlertTimer = null;
                this.wakeLock = null;
                this.geolocationWatcher = null;
                this.currentSpeed = 0;
                this.isVehicleMoving = false;
                this.lastPosition = null;
                this.autoStartEnabled = false;
                this.speedThreshold = 120;
                this.wasAboveThreshold = false;
                this.drivingMode = 'highway';
                this.fatigueDetection = 'basic';
                this.smartScheduling = 'time';
                
                // Statystyki i detekcja zmęczenia
                this.sessionStartTime = null;
                this.reactionTimes = [];
                this.consecutiveSlowReactions = 0;
                this.totalReactions = 0;
                this.alertStartTime = null;
                
                // Nowe funkcje
                this.voiceCommands = false;
                this.vibrationsEnabled = false;
                this.flashlightEnabled = false;
                this.alwaysAudio = true;
                this.copilotMode = false;
                this.recognition = null;
                this.isListening = false;
                this.websocket = null;
                this.sessionId = null;
                this.flashlightStream = null;
                
                this.initElements();
                this.initEventListeners();
                this.initGeolocation();
                this.requestWakeLock();
                this.createAlarmSound();
            }

            initElements() {
                this.intervalSelect = document.getElementById('interval');
                this.startBtn = document.getElementById('startBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.alertSection = document.getElementById('alertSection');
                this.alertBtn = document.getElementById('alertBtn');
                this.countdown = document.getElementById('countdown');
                this.statusText = document.getElementById('statusText');
                this.speedDisplay = document.getElementById('speed');
                this.gpsStatus = document.getElementById('gpsStatus');
                this.vehicleStatus = document.getElementById('vehicleStatus');
                this.vehicleStatusText = document.getElementById('vehicleStatusText');
                this.nextAlert = document.getElementById('nextAlert');
                this.alarmSound = document.getElementById('alarmSound');
                this.autoStartCheckbox = document.getElementById('autoStartEnabled');
                this.speedThresholdInput = document.getElementById('speedThreshold');
                this.drivingModeSelect = document.getElementById('drivingMode');
                this.fatigueDetectionSelect = document.getElementById('fatigueDetection');
                this.smartSchedulingSelect = document.getElementById('smartScheduling');
                this.fatigueWarning = document.getElementById('fatigueWarning');
                this.sessionStats = document.getElementById('sessionStats');
                this.sessionTime = document.getElementById('sessionTime');
                this.reactionCount = document.getElementById('reactionCount');
                this.avgReaction = document.getElementById('avgReaction');
                
                // Nowe elementy
                this.voiceCommandsCheckbox = document.getElementById('voiceCommands');
                this.vibrationsCheckbox = document.getElementById('vibrationsEnabled');
                this.flashlightCheckbox = document.getElementById('flashlightEnabled');
                this.alwaysAudioCheckbox = document.getElementById('alwaysAudio');
                this.copilotCheckbox = document.getElementById('copilotMode');
                this.qrCode = document.getElementById('qrCode');
                this.qrCanvas = document.getElementById('qrCanvas');
                this.sessionIdSpan = document.getElementById('sessionId');
                this.connectionStatus = document.getElementById('connectionStatus');
                this.voiceIndicator = document.getElementById('voiceIndicator');
                this.copilotInterface = document.getElementById('copilotInterface');
            }

            createAlarmSound() {
                // Próbujemy użyć zewnętrznego pliku audio
                this.alarmSound.addEventListener('loadeddata', () => {
                    console.log('Zewnętrzny plik alarm.mp3 załadowany pomyślnie');
                    this.useExternalAudio = true;
                });

                this.alarmSound.addEventListener('error', () => {
                    console.log('Nie można załadować alarm.mp3, używam syntetycznego dźwięku');
                    this.useExternalAudio = false;
                    this.createSyntheticAlarm();
                });

                // Sprawdź czy plik jest dostępny
                this.alarmSound.load();
                this.useExternalAudio = false; // Domyślnie false, zostanie zmienione jeśli plik się załaduje
                
                // Przygotuj zapasowy syntetyczny dźwięk
                this.createSyntheticAlarm();
            }

            createSyntheticAlarm() {
                // Tworzymy syntetyczny dźwięk alarmu za pomocą Web Audio API
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    this.createAlarmBuffer = () => {
                        const sampleRate = audioContext.sampleRate;
                        const duration = 1.0;
                        const buffer = audioContext.createBuffer(1, sampleRate * duration, sampleRate);
                        const data = buffer.getChannelData(0);
                        
                        for (let i = 0; i < data.length; i++) {
                            const time = i / sampleRate;
                            const frequency = 800 + 400 * Math.sin(2 * Math.PI * 2 * time);
                            data[i] = 0.3 * Math.sin(2 * Math.PI * frequency * time);
                        }
                        
                        return buffer;
                    };

                    this.alarmBuffer = this.createAlarmBuffer();
                    this.alarmSource = null;
                } catch (error) {
                    console.log('Web Audio API nie jest dostępne');
                }
            }

            playAlarm() {
                // Powiadom współkierowcę
                this.sendToCopilot({ type: 'alert', message: 'Kierowca nie reaguje!' });

                // Wibracje
                this.triggerVibration();

                // Latarka
                if (this.flashlightEnabled) {
                    this.initFlashlight();
                }

                // Rozpocznij rozpoznawanie mowy jeśli włączone
                if (this.voiceCommands) {
                    this.startVoiceListening();
                }

                // Najpierw spróbuj odtworzyć zewnętrzny plik audio
                if (this.useExternalAudio && this.alwaysAudio && this.alarmSound) {
                    try {
                        this.alarmSound.currentTime = 0;
                        this.alarmSound.volume = 1.0;
                        const playPromise = this.alarmSound.play();
                        
                        if (playPromise !== undefined) {
                            playPromise.then(() => {
                                console.log('Odtwarzanie zewnętrznego pliku alarm.mp3');
                            }).catch(error => {
                                console.log('Błąd odtwarzania zewnętrznego pliku, przełączam na syntetyczny');
                                this.playSyntheticAlarm();
                            });
                        }
                    } catch (error) {
                        console.log('Błąd odtwarzania zewnętrznego pliku, przełączam na syntetyczny');
                        this.playSyntheticAlarm();
                    }
                } else if (this.alwaysAudio) {
                    // Użyj syntetycznego dźwięku jako backup
                    this.playSyntheticAlarm();
                }
                
                document.body.classList.add('alarm-flash');
            }

            playSyntheticAlarm() {
                try {
                    if (this.alarmSource) {
                        this.alarmSource.stop();
                    }
                    
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.alarmSource = audioContext.createBufferSource();
                    this.alarmSource.buffer = this.alarmBuffer;
                    this.alarmSource.loop = true;
                    this.alarmSource.connect(audioContext.destination);
                    this.alarmSource.start();
                    console.log('Odtwarzanie syntetycznego alarmu');
                } catch (error) {
                    console.log('Nie można odtworzyć żadnego dźwięku');
                }
            }

            stopAlarm() {
                // Zatrzymaj zewnętrzny plik audio
                if (this.alarmSound) {
                    this.alarmSound.pause();
                    this.alarmSound.currentTime = 0;
                }
                
                // Zatrzymaj syntetyczny dźwięk
                if (this.alarmSource) {
                    try {
                        this.alarmSource.stop();
                    } catch (error) {
                        // Źródło już zatrzymane
                    }
                    this.alarmSource = null;
                }

                // Zatrzymaj latarkę
                this.stopFlashlight();

                // Zatrzymaj rozpoznawanie mowy
                this.stopVoiceRecognition();
                
                document.body.classList.remove('alarm-flash');
            }

            initEventListeners() {
                this.startBtn.addEventListener('click', () => this.start());
                this.pauseBtn.addEventListener('click', () => this.togglePause());
                this.stopBtn.addEventListener('click', () => this.stop());
                this.alertBtn.addEventListener('click', () => this.dismissAlert());
                this.intervalSelect.addEventListener('change', (e) => {
                    this.interval = parseInt(e.target.value);
                });

                this.autoStartCheckbox.addEventListener('change', (e) => {
                    this.autoStartEnabled = e.target.checked;
                    if (this.autoStartEnabled) {
                        this.statusText.textContent = 'Gotowy do auto-startu';
                    } else if (!this.isActive) {
                        this.statusText.textContent = 'Nieaktywny';
                    }
                });

                this.speedThresholdInput.addEventListener('change', (e) => {
                    this.speedThreshold = parseInt(e.target.value);
                });

                this.drivingModeSelect.addEventListener('change', (e) => {
                    this.drivingMode = e.target.value;
                    this.updateIntervalForMode();
                });

                this.fatigueDetectionSelect.addEventListener('change', (e) => {
                    this.fatigueDetection = e.target.value;
                });

                this.smartSchedulingSelect.addEventListener('change', (e) => {
                    this.smartScheduling = e.target.value;
                });

                // Nowe event listenery
                this.voiceCommandsCheckbox.addEventListener('change', (e) => {
                    this.voiceCommands = e.target.checked;
                    if (this.voiceCommands) {
                        this.initVoiceRecognition();
                    } else {
                        this.stopVoiceRecognition();
                    }
                });

                this.vibrationsCheckbox.addEventListener('change', (e) => {
                    this.vibrationsEnabled = e.target.checked;
                });

                this.flashlightCheckbox.addEventListener('change', (e) => {
                    this.flashlightEnabled = e.target.checked;
                });

                this.alwaysAudioCheckbox.addEventListener('change', (e) => {
                    this.alwaysAudio = e.target.checked;
                });

                this.copilotCheckbox.addEventListener('change', (e) => {
                    this.copilotMode = e.target.checked;
                    if (this.copilotMode) {
                        this.initCopilotMode();
                    } else {
                        this.disableCopilotMode();
                    }
                });

                // Prevent screen lock
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.isActive) {
                        this.requestWakeLock();
                    }
                });

                // Sprawdź czy to tryb współkierowcy
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('copilot')) {
                    this.initCopilotInterface(urlParams.get('copilot'));
                }
            }

            async requestWakeLock() {
                try {
                    if ('wakeLock' in navigator) {
                        this.wakeLock = await navigator.wakeLock.request('screen');
                    }
                } catch (err) {
                    console.log('Wake Lock API not supported');
                }
            }

            initGeolocation() {
                if ('geolocation' in navigator) {
                    this.geolocationWatcher = navigator.geolocation.watchPosition(
                        (position) => this.updateLocation(position),
                        (error) => this.handleGeolocationError(error),
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 5000 }
                    );
                } else {
                    this.gpsStatus.textContent = 'GPS: Niedostępny';
                }
            }

            updateLocation(position) {
                const { latitude, longitude, speed } = position.coords;
                
                // Prędkość w m/s, konwertujemy na km/h
                let speedKmh = 0;
                if (speed !== null && speed >= 0) {
                    speedKmh = Math.round(speed * 3.6);
                } else if (this.lastPosition) {
                    // Obliczamy prędkość na podstawie zmiany pozycji
                    const distance = this.calculateDistance(
                        this.lastPosition.latitude, this.lastPosition.longitude,
                        latitude, longitude
                    );
                    const timeDiff = (position.timestamp - this.lastPosition.timestamp) / 1000;
                    if (timeDiff > 0) {
                        speedKmh = Math.round((distance / timeDiff) * 3.6);
                    }
                }

                this.currentSpeed = Math.max(0, speedKmh);
                this.speedDisplay.textContent = `${this.currentSpeed} km/h`;
                
                this.isVehicleMoving = this.currentSpeed >= 1;
                this.updateVehicleStatus();
                
                // Sprawdź auto-start
                this.checkAutoStart();
                
                this.lastPosition = {
                    latitude,
                    longitude,
                    timestamp: position.timestamp
                };

                this.gpsStatus.textContent = 'GPS: Aktywny';
            }

            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371000; // Promień Ziemi w metrach
                const dLat = this.toRadians(lat2 - lat1);
                const dLon = this.toRadians(lon2 - lon1);
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(this.toRadians(lat1)) * Math.cos(this.toRadians(lat2)) *
                        Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            toRadians(degrees) {
                return degrees * (Math.PI / 180);
            }

            updateVehicleStatus() {
                if (this.isVehicleMoving) {
                    this.vehicleStatusText.textContent = 'Jadę';
                    this.vehicleStatus.className = 'vehicle-status vehicle-moving';
                } else {
                    this.vehicleStatusText.textContent = 'Stoję';
                    this.vehicleStatus.className = 'vehicle-status vehicle-stopped';
                }
                this.vehicleStatus.classList.remove('hidden');
            }

            initVoiceRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    this.recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                    this.recognition.continuous = true;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'pl-PL';

                    this.recognition.onresult = (event) => {
                        const lastResult = event.results[event.results.length - 1];
                        if (lastResult.isFinal) {
                            const transcript = lastResult[0].transcript.toLowerCase();
                            if (transcript.includes('czuwam') || transcript.includes('czuam')) {
                                this.dismissAlert();
                            }
                        }
                    };

                    this.recognition.onerror = (event) => {
                        console.log('Błąd rozpoznawania mowy:', event.error);
                        this.voiceIndicator.classList.remove('listening');
                    };

                    console.log('Rozpoznawanie mowy zostało zainicjowane');
                } else {
                    console.log('Rozpoznawanie mowy nie jest obsługiwane');
                    this.voiceCommandsCheckbox.checked = false;
                    this.voiceCommands = false;
                }
            }

            startVoiceListening() {
                if (this.recognition && this.voiceCommands && !this.isListening) {
                    try {
                        this.recognition.start();
                        this.isListening = true;
                        this.voiceIndicator.classList.add('listening');
                    } catch (error) {
                        console.log('Nie można uruchomić rozpoznawania mowy:', error);
                    }
                }
            }

            stopVoiceRecognition() {
                if (this.recognition) {
                    this.recognition.stop();
                    this.isListening = false;
                    this.voiceIndicator.classList.remove('listening');
                }
            }

            triggerVibration() {
                if (this.vibrationsEnabled && 'vibrate' in navigator) {
                    // Wzór wibracji: [vibrate, pause, vibrate, pause, ...]
                    navigator.vibrate([500, 200, 500, 200, 1000]);
                }
            }

            async initFlashlight() {
                if (this.flashlightEnabled) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: 'environment' }
                        });
                        
                        const track = stream.getVideoTracks()[0];
                        if ('torch' in track.getCapabilities()) {
                            this.flashlightStream = { stream, track };
                            this.toggleFlashlight(true);
                        } else {
                            // Fallback: migający ekran
                            document.body.classList.add('flashlight-active');
                        }
                    } catch (error) {
                        console.log('Nie można uzyskać dostępu do latarki:', error);
                        // Fallback: migający ekran
                        document.body.classList.add('flashlight-active');
                    }
                }
            }

            toggleFlashlight(enabled) {
                if (this.flashlightStream && this.flashlightStream.track) {
                    this.flashlightStream.track.applyConstraints({
                        advanced: [{ torch: enabled }]
                    }).catch(() => {
                        // Fallback jeśli torch nie działa
                        if (enabled) {
                            document.body.classList.add('flashlight-active');
                        } else {
                            document.body.classList.remove('flashlight-active');
                        }
                    });
                } else if (enabled) {
                    document.body.classList.add('flashlight-active');
                } else {
                    document.body.classList.remove('flashlight-active');
                }
            }

            stopFlashlight() {
                this.toggleFlashlight(false);
                document.body.classList.remove('flashlight-active');
                
                if (this.flashlightStream) {
                    this.flashlightStream.stream.getTracks().forEach(track => track.stop());
                    this.flashlightStream = null;
                }
            }

            initCopilotMode() {
                this.sessionId = this.generateSessionId();
                this.sessionIdSpan.textContent = this.sessionId;
                this.generateQRCode();
                this.qrCode.classList.add('show');
                this.startWebSocketServer();
            }

            disableCopilotMode() {
                this.qrCode.classList.remove('show');
                if (this.websocket) {
                    this.websocket.close();
                    this.websocket = null;
                }
                this.connectionStatus.className = 'connection-status status-disconnected';
                this.connectionStatus.textContent = '🔴 Współkierowca niepołączony';
            }

            generateSessionId() {
                return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            }

            generateQRCode() {
                const copilotUrl = `${window.location.origin}${window.location.pathname}?copilot=${this.sessionId}`;
                
                // Prosta implementacja QR kodu (fallback do URL-a)
                const canvas = this.qrCanvas;
                const ctx = canvas.getContext('2d');
                canvas.width = 200;
                canvas.height = 200;
                
                // Wypełnij białym tłem
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, 200, 200);
                
                // Dodaj tekst z URL-em
                ctx.fillStyle = 'black';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Otwórz link w drugiej', 100, 50);
                ctx.fillText('aplikacji:', 100, 70);
                ctx.font = '10px Arial';
                
                // Podziel URL na linie
                const urlParts = copilotUrl.match(/.{1,25}/g) || [copilotUrl];
                urlParts.forEach((part, index) => {
                    ctx.fillText(part, 100, 100 + (index * 15));
                });
            }

            startWebSocketServer() {
                // Symulacja WebSocket przez localStorage (dla demo)
                // W prawdziwej implementacji używałbyś WebRTC lub zewnętrznego serwera
                this.websocket = {
                    send: (data) => {
                        localStorage.setItem(`copilot_${this.sessionId}`, JSON.stringify({
                            ...JSON.parse(data),
                            timestamp: Date.now()
                        }));
                    },
                    close: () => {
                        localStorage.removeItem(`copilot_${this.sessionId}`);
                    }
                };

                // Sprawdzaj połączenie co sekundę
                this.copilotCheckInterval = setInterval(() => {
                    const copilotData = localStorage.getItem(`copilot_${this.sessionId}_response`);
                    if (copilotData) {
                        const data = JSON.parse(copilotData);
                        if (data.type === 'connected') {
                            this.connectionStatus.className = 'connection-status status-connected';
                            this.connectionStatus.textContent = '🟢 Współkierowca połączony';
                        }
                    }
                }, 1000);
            }

            initCopilotInterface(sessionId) {
                this.sessionId = sessionId;
                document.querySelector('.container').style.display = 'none';
                this.copilotInterface.classList.add('active');
                
                // Połącz się z kierowcą
                this.connectToCopilot();
            }

            connectToCopilot() {
                // Wyślij sygnał połączenia
                localStorage.setItem(`copilot_${this.sessionId}_response`, JSON.stringify({
                    type: 'connected',
                    timestamp: Date.now()
                }));

                // Nasłuchuj alertów
                this.copilotListenInterval = setInterval(() => {
                    const alertData = localStorage.getItem(`copilot_${this.sessionId}`);
                    if (alertData) {
                        const data = JSON.parse(alertData);
                        if (data.type === 'alert' && Date.now() - data.timestamp < 5000) {
                            this.showCopilotAlert();
                        }
                    }
                }, 500);

                document.getElementById('copilotConnectionStatus').className = 'connection-status status-connected';
                document.getElementById('copilotConnectionStatus').textContent = '🟢 Połączony z kierowcą';
            }

            showCopilotAlert() {
                const alertDiv = document.getElementById('copilotAlert');
                alertDiv.style.display = 'block';
                
                // Wibracje i dźwięk dla współkierowcy
                if ('vibrate' in navigator) {
                    navigator.vibrate([1000, 500, 1000]);
                }
            }

            sendToCopilot(data) {
                if (this.websocket && this.copilotMode) {
                    this.websocket.send(JSON.stringify(data));
                }
            }
                const baseInterval = parseInt(this.intervalSelect.value);
                let modifier = 1;

                switch(this.drivingMode) {
                    case 'city':
                        modifier = 0.7; // 30% częściej
                        break;
                    case 'highway':
                        modifier = 1; // Standard
                        break;
                    case 'night':
                        modifier = 0.5; // 50% częściej
                        break;
                    case 'fatigue':
                        modifier = 0.3; // 70% częściej
                        break;
                }

                // Smart scheduling - godziny wysokiego ryzyka (2:00-6:00)
                if (this.smartScheduling === 'time' || this.smartScheduling === 'adaptive') {
                    const hour = new Date().getHours();
                    if (hour >= 2 && hour <= 6) {
                        modifier *= 0.6; // Jeszcze częściej w nocy
                    }
                }

                this.currentInterval = Math.round(baseInterval * modifier);
            }
                if (!this.autoStartEnabled || this.isActive) {
                    return;
                }

                // Sprawdź czy prędkość była wcześniej powyżej progu
                if (this.currentSpeed >= this.speedThreshold) {
                    this.wasAboveThreshold = true;
                    this.statusText.textContent = `Gotowy - Prędkość: ${this.currentSpeed} km/h`;
                    return;
                }

                // Jeśli prędkość spadła poniżej progu i wcześniej była powyżej
                if (this.wasAboveThreshold && this.currentSpeed < this.speedThreshold && this.currentSpeed > 10) {
                    this.statusText.textContent = `🚀 AUTO-START! Prędkość spadła do ${this.currentSpeed} km/h`;
                    setTimeout(() => {
                        this.start();
                    }, 2000); // 2 sekundy opóźnienia na przygotowanie
                }
            }

            handleGeolocationError(error) {
                this.gpsStatus.textContent = `GPS: Błąd (${error.message})`;
            }

            start() {
                this.isActive = true;
                this.isPaused = false;
                this.wasAboveThreshold = false; // Reset auto-start
                this.sessionStartTime = Date.now();
                this.reactionTimes = [];
                this.consecutiveSlowReactions = 0;
                this.totalReactions = 0;
                
                this.startBtn.classList.add('hidden');
                this.pauseBtn.classList.remove('hidden');
                this.stopBtn.classList.remove('hidden');
                this.sessionStats.style.display = 'block';
                this.statusText.textContent = 'Aktywny - Monitorowanie';
                
                this.updateIntervalForMode();
                this.scheduleNextAlert();
            }

            stop() {
                this.isActive = false;
                this.isPaused = false;
                this.wasAboveThreshold = false; // Reset auto-start
                this.sessionStartTime = null;
                this.clearAllTimers();
                this.stopAlarm();
                this.hideAlert();
                this.hideFatigueWarning();
                
                this.startBtn.classList.remove('hidden');
                this.pauseBtn.classList.add('hidden');
                this.stopBtn.classList.add('hidden');
                this.sessionStats.style.display = 'none';
                
                if (this.autoStartEnabled) {
                    this.statusText.textContent = 'Gotowy do auto-startu';
                } else {
                    this.statusText.textContent = 'Nieaktywny';
                }
                this.nextAlert.textContent = '';
            }

            togglePause() {
                if (this.isPaused) {
                    this.isPaused = false;
                    this.pauseBtn.textContent = '⏸️ Zatrzymaj';
                    this.statusText.textContent = 'Aktywny - Monitorowanie';
                    this.scheduleNextAlert();
                } else {
                    this.isPaused = true;
                    this.pauseBtn.textContent = '▶️ Wznów';
                    this.statusText.textContent = 'Wstrzymany';
                    this.clearAllTimers();
                    this.nextAlert.textContent = '';
                }
            }

            scheduleNextAlert() {
                if (!this.isActive || this.isPaused) return;

                // Sprawdź czy pojazd się porusza
                if (!this.isVehicleMoving && this.currentSpeed < 1) {
                    this.statusText.textContent = 'Wstrzymany - Pojazd stoi';
                    // Sprawdź ponownie za 5 sekund
                    this.nextAlertTimer = setTimeout(() => this.scheduleNextAlert(), 5000);
                    return;
                }

                this.statusText.textContent = 'Aktywny - Monitorowanie';
                const nextAlertTime = new Date(Date.now() + (this.currentInterval || this.interval) * 1000);
                this.updateNextAlertDisplay(nextAlertTime);

                this.alertTimer = setTimeout(() => {
                    this.showAlert();
                }, (this.currentInterval || this.interval) * 1000);
            }

            updateNextAlertDisplay(nextTime) {
                const updateDisplay = () => {
                    if (!this.isActive || this.isPaused) {
                        this.nextAlert.textContent = '';
                        return;
                    }

                    const now = new Date();
                    const diff = Math.max(0, Math.ceil((nextTime - now) / 1000));
                    
                    if (diff > 0) {
                        const minutes = Math.floor(diff / 60);
                        const seconds = diff % 60;
                        this.nextAlert.textContent = `Następne przypomnienie za: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                        setTimeout(updateDisplay, 1000);
                    } else {
                        this.nextAlert.textContent = '';
                    }
                };
                updateDisplay();
            }

            showAlert() {
                this.alertStartTime = Date.now();
                this.alertSection.classList.remove('hidden');
                this.startCountdown();
            }

            hideAlert() {
                this.alertSection.classList.add('hidden');
                this.clearCountdown();
            }

            startCountdown() {
                let timeLeft = 15;
                this.countdown.textContent = timeLeft;

                this.countdownTimer = setInterval(() => {
                    timeLeft--;
                    this.countdown.textContent = timeLeft;

                    if (timeLeft <= 0) {
                        this.triggerAlarm();
                    }
                }, 1000);
            }

            clearCountdown() {
                if (this.countdownTimer) {
                    clearInterval(this.countdownTimer);
                    this.countdownTimer = null;
                }
            }

            triggerAlarm() {
                this.clearCountdown();
                this.playAlarm();
                this.statusText.textContent = '🚨 ALARM! Kliknij przycisk!';
            }

            dismissAlert() {
                const reactionTime = this.alertStartTime ? Date.now() - this.alertStartTime : 0;
                this.analyzeReactionTime(reactionTime);
                
                this.hideAlert();
                this.stopAlarm();
                this.statusText.textContent = 'Aktywny - Monitorowanie';
                this.scheduleNextAlert();
            }

            clearAllTimers() {
                if (this.alertTimer) {
                    clearTimeout(this.alertTimer);
                    this.alertTimer = null;
                }
                if (this.nextAlertTimer) {
                    clearTimeout(this.nextAlertTimer);
                    this.nextAlertTimer = null;
                }
                this.clearCountdown();
            }
        }

        // Inicjalizacja aplikacji
        document.addEventListener('DOMContentLoaded', () => {
            window.czuwakApp = new CzuwakKierowcy();
        });

        // Klasa dla współkierowcy
        class CopilotApp {
            wakeDriver() {
                alert('📢 Zbudzenie kierowcy! (w rzeczywistej implementacji wyślę sygnał)');
                document.getElementById('copilotAlert').style.display = 'none';
            }

            disconnect() {
                if (confirm('Czy na pewno chcesz się rozłączyć?')) {
                    window.location.href = window.location.pathname;
                }
            }
        }

        window.copilotApp = new CopilotApp();

        // Service Worker dla PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4gewogIGV2ZW50LndhaXRVbnRpbChzZWxmLnNraXBXYWl0aW5nKCkpOwp9KTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignZmV0Y2gnLCBldmVudCA9PiB7CiAgZXZlbnQucmVzcG9uZFdpdGgoCiAgICBjYWNoZXMubWF0Y2goZXZlbnQucmVxdWVzdCkudGhlbihyZXNwb25zZSA9PiB7CiAgICAgIHJldHVybiByZXNwb25zZSB8fCBmZXRjaChldmVudC5yZXF1ZXN0KTsKICAgIH0pCiAgKTsKfSk7')
              .then(() => console.log('Service Worker zarejestrowany'))
              .catch(err => console.log('Service Worker błąd:', err));
        }
    </script>
</body>
</html>
